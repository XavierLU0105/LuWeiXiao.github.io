<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Googley Countdown</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fdfcff">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3652/3652191.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href='data:application/json;base64,eyJuYW1lIjoiR29vZ2xleSBDb3VudGRvd24iLCJzaG9ydF9uYW1lIjoiQ291bnRkb3duIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzM2NTIvMzY1MjE5MS5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dLCJzdGFydF91cmwiOiIuaW5kZXguaHRtbCIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZGZjZmYiLCJ0aGVtZV9jb2xvciI6IiMwMDYxYTQifQ=='>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: { 
                extend: {
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                        sans: ['"Noto Sans SC"', 'Roboto', '"Microsoft YaHei"', '"PingFang SC"', 'sans-serif'],
                    },
                    screens: { '3xl': '1800px' }
                } 
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Identity -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Html2Canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            /* Default MD3 Orange/Coffee Palette */
            --md-sys-color-primary: #8b5000;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #ffdcbe;
            --md-sys-color-on-primary-container: #2c1600;
            --md-sys-color-secondary: #725a42;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #fdddbd;
            --md-sys-color-on-secondary-container: #2a1806;
            --md-sys-color-tertiary: #58633a;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #dbe8b4;
            --md-sys-color-on-tertiary-container: #161f01;
            --md-sys-color-background: #fff8f6;
            --md-sys-color-on-background: #1f1b16;
            --md-sys-color-surface: #fff8f6;
            --md-sys-color-on-surface: #1f1b16;
            --md-sys-color-surface-variant: #f0e0cf;
            --md-sys-color-on-surface-variant: #4f4539;
            --md-sys-color-outline: #817567;
            --md-sys-color-surface-container: #fcece4;
            --md-sys-color-surface-container-high: #f6e6de;
        }

        .dark-theme {
            --md-sys-color-primary: #ffb870;
            --md-sys-color-on-primary: #4a2800;
            --md-sys-color-primary-container: #6a3c00;
            --md-sys-color-on-primary-container: #ffdcbe;
            --md-sys-color-secondary: #e0c1a3;
            --md-sys-color-on-secondary: #402d18;
            --md-sys-color-secondary-container: #58432c;
            --md-sys-color-on-secondary-container: #fdddbd;
            --md-sys-color-tertiary: #bfcca0;
            --md-sys-color-on-tertiary: #2b341a;
            --md-sys-color-tertiary-container: #414b29;
            --md-sys-color-on-tertiary-container: #dbe8b4;
            --md-sys-color-background: #1f1b16;
            --md-sys-color-on-background: #eae1d9;
            --md-sys-color-surface: #1f1b16;
            --md-sys-color-on-surface: #eae1d9;
            --md-sys-color-surface-variant: #4f4539;
            --md-sys-color-on-surface-variant: #d3c4b4;
            --md-sys-color-outline: #9c8f80;
            --md-sys-color-surface-container: #2a241f;
            --md-sys-color-surface-container-high: #352f29;
        }

        body {
            font-family: 'Roboto', 'Noto Sans SC', "Microsoft YaHei", sans-serif;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            transition: background-color 0.4s ease, color 0.4s ease;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow-x: hidden;
        }

        .material-symbols-rounded { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        .icon-filled { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .animate-enter { animation: fade-up 0.4s cubic-bezier(0.05, 0.7, 0.1, 1.0) forwards; }
        @keyframes fade-up { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const MIcon = ({ name, className = "", filled = false, size = 24 }) => (
            <span className={`material-symbols-rounded ${filled ? 'icon-filled' : ''} ${className}`} style={{ fontSize: `${size}px` }}>{name}</span>
        );

        const getLocalDateString = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        };

        const THEMES = {
            'blue': {
                light: { primary: '#0061a4', onPrimary: '#ffffff', primaryContainer: '#d1e4ff', onPrimaryContainer: '#001d36', secondary: '#535f70', onSecondary: '#ffffff', secondaryContainer: '#d7e3f7', onSecondaryContainer: '#101c2b', tertiary: '#6b5778', onTertiary: '#ffffff', tertiaryContainer: '#f2daff', onTertiaryContainer: '#251431', background: '#fdfcff', onBackground: '#1a1c1e', surface: '#fdfcff', onSurface: '#1a1c1e', surfaceVariant: '#dfe2eb', onSurfaceVariant: '#43474e', outline: '#73777f', surfaceContainer: '#f0f4f9', surfaceContainerHigh: '#ebeef5' },
                dark: { primary: '#9ecaff', onPrimary: '#003258', primaryContainer: '#00497d', onPrimaryContainer: '#d1e4ff', secondary: '#bbc7db', onSecondary: '#253140', secondaryContainer: '#3b4858', onSecondaryContainer: '#d7e3f7', tertiary: '#d7bee4', onTertiary: '#3b2948', tertiaryContainer: '#523f5f', onTertiaryContainer: '#f2daff', background: '#1a1c1e', onBackground: '#e2e2e6', surface: '#1a1c1e', onSurface: '#e2e2e6', surfaceVariant: '#43474e', onSurfaceVariant: '#c3c7cf', outline: '#8d9199', surfaceContainer: '#1e2227', surfaceContainerHigh: '#282c34' }
            },
            'green': {
                light: { primary: '#006e1c', onPrimary: '#ffffff', primaryContainer: '#94f990', onPrimaryContainer: '#002204', secondary: '#52634f', onSecondary: '#ffffff', secondaryContainer: '#d5e8cf', onSecondaryContainer: '#111f0c', tertiary: '#38656a', onTertiary: '#ffffff', tertiaryContainer: '#bcebf0', onTertiaryContainer: '#002023', background: '#fcfdf6', onBackground: '#1a1c1e', surface: '#fcfdf6', onSurface: '#1a1c1e', surfaceVariant: '#dee5d8', onSurfaceVariant: '#424940', outline: '#72796f', surfaceContainer: '#f0f5eb', surfaceContainerHigh: '#eaefe5' },
                dark: { primary: '#78dc77', onPrimary: '#00390a', primaryContainer: '#005313', onPrimaryContainer: '#94f990', secondary: '#baccb3', onSecondary: '#253423', secondaryContainer: '#3b4b38', onSecondaryContainer: '#d5e8cf', tertiary: '#a0cfd4', onTertiary: '#00363b', tertiaryContainer: '#1f4d52', onTertiaryContainer: '#bcebf0', background: '#1a1c1e', onBackground: '#e2e2e6', surface: '#1a1c1e', onSurface: '#e2e2e6', surfaceVariant: '#424940', onSurfaceVariant: '#c2c8bd', outline: '#8c9388', surfaceContainer: '#1a211b', surfaceContainerHigh: '#252b26' }
            },
            'orange': { 
                light: { primary: '#8b5000', onPrimary: '#ffffff', primaryContainer: '#ffdcbe', onPrimaryContainer: '#2c1600', secondary: '#725a42', onSecondary: '#ffffff', secondaryContainer: '#fdddbd', onSecondaryContainer: '#2a1806', tertiary: '#58633a', onTertiary: '#ffffff', tertiaryContainer: '#dbe8b4', onTertiaryContainer: '#161f01', background: '#fff8f6', onBackground: '#1f1b16', surface: '#fff8f6', onSurface: '#1f1b16', surfaceVariant: '#f0e0cf', onSurfaceVariant: '#4f4539', outline: '#817567', surfaceContainer: '#fcece4', surfaceContainerHigh: '#f6e6de' },
                dark: { primary: '#ffb870', onPrimary: '#4a2800', primaryContainer: '#6a3c00', onPrimaryContainer: '#ffdcbe', secondary: '#e0c1a3', onSecondary: '#402d18', secondaryContainer: '#58432c', onSecondaryContainer: '#fdddbd', tertiary: '#bfcca0', onTertiary: '#2b341a', tertiaryContainer: '#414b29', onTertiaryContainer: '#dbe8b4', background: '#1f1b16', onBackground: '#eae1d9', surface: '#1f1b16', onSurface: '#eae1d9', surfaceVariant: '#4f4539', onSurfaceVariant: '#d3c4b4', outline: '#9c8f80', surfaceContainer: '#2a241f', surfaceContainerHigh: '#352f29' }
            },
            'purple': {
                light: { primary: '#74479e', onPrimary: '#ffffff', primaryContainer: '#efdbff', onPrimaryContainer: '#2c0051', secondary: '#665a6f', onSecondary: '#ffffff', secondaryContainer: '#edddf6', onSecondaryContainer: '#21182a', tertiary: '#805158', onTertiary: '#ffffff', tertiaryContainer: '#ffd9de', onTertiaryContainer: '#321017', background: '#fffbfe', onBackground: '#1d1b1e', surface: '#fffbfe', onSurface: '#1d1b1e', surfaceVariant: '#e9dfeb', onSurfaceVariant: '#4a454d', outline: '#7c757e', surfaceContainer: '#f5eff8', surfaceContainerHigh: '#f0e9f3' },
                dark: { primary: '#dcb8ff', onPrimary: '#43126c', primaryContainer: '#5b2f84', onPrimaryContainer: '#efdbff', secondary: '#d0c1da', onSecondary: '#362c3f', secondaryContainer: '#4e4256', onSecondaryContainer: '#edddf6', tertiary: '#f3b7be', onTertiary: '#4b252b', tertiaryContainer: '#653b41', onTertiaryContainer: '#ffd9de', background: '#1d1b1e', onBackground: '#e6e1e6', surface: '#1d1b1e', onSurface: '#e6e1e6', surfaceVariant: '#4a454d', onSurfaceVariant: '#ccc4ce', outline: '#968e98', surfaceContainer: '#221f26', surfaceContainerHigh: '#2c2930' }
            },
            'red': {
                light: { primary: '#bf0031', onPrimary: '#ffffff', primaryContainer: '#ffdadb', onPrimaryContainer: '#40000a', secondary: '#775656', onSecondary: '#ffffff', secondaryContainer: '#ffdadb', onSecondaryContainer: '#2c1516', tertiary: '#755a2f', onTertiary: '#ffffff', tertiaryContainer: '#ffdea6', onTertiaryContainer: '#271900', background: '#fffbfa', onBackground: '#201a1a', surface: '#fffbfa', onSurface: '#201a1a', surfaceVariant: '#f4dddd', onSurfaceVariant: '#534343', outline: '#857373', surfaceContainer: '#f5efef', surfaceContainerHigh: '#efe9e9' },
                dark: { primary: '#ffb3b4', onPrimary: '#680016', primaryContainer: '#920023', onPrimaryContainer: '#ffdadb', secondary: '#e6bdbe', onSecondary: '#44292a', secondaryContainer: '#5d3f3f', onSecondaryContainer: '#ffdadb', tertiary: '#e5c18d', onTertiary: '#422c05', tertiaryContainer: '#5b421a', onTertiaryContainer: '#ffdea6', background: '#201a1a', onBackground: '#ece0e0', surface: '#201a1a', onSurface: '#ece0e0', surfaceVariant: '#534343', onSurfaceVariant: '#d8c2c2', outline: '#a08c8c', surfaceContainer: '#2a2021', surfaceContainerHigh: '#352a2b' }
            }
        };

        const App = () => {
            // --- 1. CORE State ---
            const [items, setItems] = useState([]);
            const [modalMode, setModalMode] = useState(null); 
            const [editingItem, setEditingItem] = useState(null);
            const [appTheme, setAppTheme] = useState('orange'); 
            const [darkMode, setDarkMode] = useState('system'); 
            const [webdavConfig, setWebdavConfig] = useState({ url: '', username: '', password: '', filename: 'countdown_backup.json', autoSync: false });
            const [driveConfig, setDriveConfig] = useState({ clientId: '', autoSync: false });
            const [activeCategory, setActiveCategory] = useState('All'); 
            const [saveStatus, setSaveStatus] = useState('idle');
            const [driveConnection, setDriveConnection] = useState('disconnected');
            const [shareImgUrl, setShareImgUrl] = useState(null);
            const [activeSyncTab, setActiveSyncTab] = useState('webdav'); 
            const [gAccessToken, setGAccessToken] = useState(null);
            const [formData, setFormData] = useState({ title: '', date: '', endDate: '', repeatType: 'none', isPinned: false, category: '', statusText: '', remarks: '' });
            const [isLoading, setIsLoading] = useState(false);
            const [syncStatus, setSyncStatus] = useState({ type: '', msg: '' });

            const isFirstMount = useRef(true);
            const shareRef = useRef(null);
            const fileInputRef = useRef(null);

            // --- 2. MD3 Theme Logic (Hoisted) ---
            const handleThemeChange = (color, mode) => {
                const t = THEMES[color] || THEMES['orange']; 
                const isDark = mode === 'system' ? window.matchMedia('(prefers-color-scheme: dark)').matches : mode === 'dark';
                const palette = isDark ? t.dark : t.light;
                const root = document.documentElement;
                
                setAppTheme(color); setDarkMode(mode);
                localStorage.setItem('md_app_theme', color);
                localStorage.setItem('md_dark_mode', mode);

                if (isDark) root.classList.add('dark-theme'); else root.classList.remove('dark-theme');
                for (const [key, value] of Object.entries(palette)) {
                    const kebabKey = key.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    root.style.setProperty(`--md-sys-color-${kebabKey}`, value);
                }
                const metaThemeColor = document.querySelector("meta[name=theme-color]");
                if(metaThemeColor) metaThemeColor.setAttribute("content", palette.background);
            };

            // --- 3. Memoized Helpers (Hoisted) ---
            const availableCategories = useMemo(() => {
                const cats = new Set();
                items.forEach(i => { if (i.category && i.category.trim() !== '') cats.add(i.category); });
                return ['All', ...Array.from(cats)];
            }, [items]);

            const calculateDaysInternal = (item) => {
                if (item.endDate) {
                    const start = new Date(item.date); const end = new Date(item.endDate);
                    start.setHours(0,0,0,0); end.setHours(0,0,0,0);
                    const diffDays = Math.ceil(Math.abs(end - start) / 86400000);
                    return { days: diffDays, date: end, isPast: true, isDuration: true };
                }
                const now = new Date(); now.setHours(0,0,0,0);
                if (!item.date) return { days: 0, date: now, isPast: false };
                const [y, m, d] = item.date.split('-').map(Number);
                const targetBase = new Date(y, m - 1, d);
                let target = new Date(targetBase); let isPast = false;
                if (item.repeatType && item.repeatType !== 'none') {
                    let next = new Date(targetBase);
                    if (item.repeatType === 'week') { while(next < now) next.setDate(next.getDate() + 7); }
                    else if (item.repeatType === 'month') { while(next < now) next.setMonth(next.getMonth() + 1); }
                    else if (item.repeatType === 'year') { while(next < now) next.setFullYear(next.getFullYear() + 1); }
                    target = next;
                } else if (target < now) { isPast = true; }
                const rawDays = Math.ceil((target - now) / 86400000);
                return { days: Math.abs(rawDays), date: target, isPast };
            };

            const shareItemInfo = useMemo(() => editingItem ? calculateDaysInternal(formData) : { days: 0, isPast: false }, [editingItem, formData]);

            // --- 4. Sync Operations (Hoisted) ---
            const performDriveOp = async (accessToken, action, isSilent) => {
                try {
                    const FOLDER_NAME = 'Googley Countdown Data'; const FILENAME = 'countdown_backup.json';
                    const folderSearchRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.folder' and name='${FOLDER_NAME}' and trashed=false`, { headers: { Authorization: `Bearer ${accessToken}` } });
                    const folderData = await folderSearchRes.json();
                    let folderId = folderData.files?.[0]?.id;
                    if (!folderId) {
                        const createFolder = await fetch('https://www.googleapis.com/drive/v3/files', { method: 'POST', headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ name: FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' }) });
                        folderId = (await createFolder.json()).id;
                    }
                    if (action === 'connect') { setDriveConnection('connected'); return; }
                    const fileSearch = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${FILENAME}' and '${folderId}' in parents and trashed=false`, { headers: { Authorization: `Bearer ${accessToken}` } });
                    const fileId = (await fileSearch.json()).files?.[0]?.id;
                    if (action === 'upload') {
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify({ name: FILENAME, mimeType: 'application/json', parents: fileId ? [] : [folderId] })], { type: 'application/json' }));
                        form.append('file', new Blob([JSON.stringify(items)], { type: 'application/json' }));
                        const url = fileId ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart` : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
                        const res = await fetch(url, { method: fileId ? 'PATCH' : 'POST', headers: { Authorization: `Bearer ${accessToken}` }, body: form });
                        if (res.ok) { setSaveStatus('success'); setTimeout(() => setSaveStatus('idle'), 2000); }
                    } else if (action === 'download') {
                        const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: { Authorization: `Bearer ${accessToken}` } });
                        if (res.ok) setItems(await res.json());
                    }
                } catch (e) { setSaveStatus('error'); } finally { setIsLoading(false); }
            };

            const handleGoogleDriveAction = async (action, isSilent = false) => {
                if (!window.google) return;
                const client = google.accounts.oauth2.initTokenClient({ client_id: driveConfig.clientId, scope: 'https://www.googleapis.com/auth/drive.file', callback: async (resp) => {
                    if (resp.error) { setSaveStatus('error'); setIsLoading(false); return; }
                    const expiresAt = Date.now() + (resp.expires_in * 1000) - 60000;
                    const tokenObj = { token: resp.access_token, expiresAt };
                    setGAccessToken(tokenObj); localStorage.setItem('md_g_token', JSON.stringify(tokenObj));
                    setDriveConnection('connected'); await performDriveOp(resp.access_token, action, isSilent);
                }});
                const isTokenValid = gAccessToken && Date.now() < gAccessToken.expiresAt;
                if (!isTokenValid) {
                    if (isSilent) { setSaveStatus('error'); return; }
                    setIsLoading(true); client.requestAccessToken();
                } else {
                    if (!isSilent) setIsLoading(true); else setSaveStatus('syncing');
                    await performDriveOp(gAccessToken.token, action, isSilent);
                }
            };

            const handleWebDAV = async (isUpload, isSilent) => {
                if(!webdavConfig.url) return; setSaveStatus('syncing');
                try {
                    let u = webdavConfig.url.endsWith('/') ? webdavConfig.url : webdavConfig.url + '/'; u += webdavConfig.filename;
                    const options = { method: isUpload ? 'PUT' : 'GET', headers: {'Authorization': 'Basic ' + btoa(unescape(encodeURIComponent(webdavConfig.username + ':' + webdavConfig.password)))} };
                    if(isUpload) { options.headers['Content-Type']='application/json'; options.body=JSON.stringify(items); }
                    const res = await nativeFetch(u, options);
                    if(res.ok) { if(!isUpload) setItems(await res.json()); setSaveStatus('success'); setTimeout(() => setSaveStatus('idle'), 2000); }
                } catch(e) { setSaveStatus('error'); } finally { setIsLoading(false); }
            };

            // --- 5. Lifecycle Effects ---
            useEffect(() => {
                try {
                    const savedItems = localStorage.getItem('md_countdowns'); if (savedItems) setItems(JSON.parse(savedItems));
                    const savedConfig = localStorage.getItem('md_webdav_config'); if (savedConfig) setWebdavConfig(JSON.parse(savedConfig));
                    const savedDrive = localStorage.getItem('md_drive_config'); if (savedDrive) { const parsed = JSON.parse(savedDrive); setDriveConfig(parsed); if (parsed.clientId && parsed.clientId.length > 5) setActiveSyncTab('drive'); }
                    const cachedToken = localStorage.getItem('md_g_token'); if (cachedToken) { const parsedToken = JSON.parse(cachedToken); if (parsedToken.expiresAt > Date.now()) { setGAccessToken(parsedToken); setDriveConnection('connected'); }}
                    const savedTheme = localStorage.getItem('md_app_theme') || 'orange'; const savedDark = localStorage.getItem('md_dark_mode') || 'system';
                    handleThemeChange(savedTheme, savedDark); 
                } catch (e) { console.error("LocalStorage parsing error", e); }
                if (window.plus) setIsAppMode(true);
            }, []);

            useEffect(() => {
                if (isFirstMount.current) { isFirstMount.current = false; return; }
                if ((driveConfig.autoSync && driveConfig.clientId) || (webdavConfig.autoSync && webdavConfig.url)) setSaveStatus('pending');
                else { setSaveStatus('idle'); return; }
                const timer = setTimeout(() => {
                    if (driveConfig.autoSync && driveConfig.clientId) handleGoogleDriveAction('upload', true);
                    else if (webdavConfig.autoSync && webdavConfig.url) handleWebDAV(true, true);
                    else setSaveStatus('idle');
                }, 2000); 
                return () => clearTimeout(timer);
            }, [items, driveConfig.autoSync, webdavConfig.autoSync]);

            // --- 6. UI Interaction ---
            const handleRefresh = () => { if (isLoading) return; if (driveConfig.clientId) handleGoogleDriveAction('download'); else if (webdavConfig.url) handleWebDAV(false); else location.reload(); };
            const handleSave = (e) => { e.preventDefault(); const newItem = { ...formData, id: editingItem ? editingItem.id : Date.now().toString() }; setItems(editingItem ? items.map(i => i.id === newItem.id ? newItem : i) : [...items, newItem]); setModalMode(null); };
            const handleDelete = () => { if (confirm('确定删除?')) { setItems(items.filter(i => i.id !== editingItem.id)); setModalMode(null); } };
            const openAddEdit = (item = null) => { setEditingItem(item); if (item) setFormData(item); else setFormData({ title: '', date: getLocalDateString(), endDate: '', repeatType: 'none', isPinned: false, category: (activeCategory !== 'All') ? activeCategory : '', statusText: '', remarks: '' }); setModalMode('add'); };
            const handleExportLocal = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ items, settings: { appTheme, darkMode } })); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `googley_backup_${Date.now()}.json`); dl.click(); };
            
            const sortedItems = useMemo(() => {
                let filtered = items;
                if (activeCategory !== 'All') filtered = items.filter(i => i.category === activeCategory);
                return filtered.sort((a, b) => (a.isPinned === b.isPinned) ? 0 : a.isPinned ? -1 : 1);
            }, [items, activeCategory]);

            const getThemeBackground = () => {
                const isDark = document.documentElement.classList.contains('dark-theme');
                if (isDark) return 'bg-gradient-to-br from-[#1e1b16] to-[#332b24]'; 
                return 'bg-gradient-to-br from-[#fff8f6] to-[#fcece4]'; 
            };

            return (
                <div className={`min-h-screen pb-24 select-none flex flex-col bg-surface transition-colors duration-300 ${getThemeBackground()}`}>
                    <header className="sticky top-0 z-20 px-6 pt-6 pb-2 backdrop-blur-xl bg-surface/70 flex flex-col gap-4 shadow-sm border-b border-outline/5">
                        <div className="flex justify-between items-center">
                            <span className="text-2xl font-bold text-on-surface tracking-tight">Googley Countdown</span>
                            <div className="flex items-center gap-3">
                                <div className={`flex items-center gap-1.5 transition-all duration-300 ${saveStatus !== 'idle' ? 'opacity-100' : ''}`}>
                                    {saveStatus === 'pending' && <span className="text-xs font-bold text-on-surface-variant/50">准备同步...</span>}
                                    {saveStatus === 'syncing' && <div className="flex items-center gap-1 text-primary"><MIcon name="sync" className="animate-spin text-sm" size={16} /><span className="text-xs font-bold">正在保存...</span></div>}
                                    {saveStatus === 'success' && <div className="flex items-center gap-1 text-success font-bold text-xs"><MIcon name="check_circle" size={16} />已保存</div>}
                                    {saveStatus === 'error' && <button onClick={() => handleGoogleDriveAction('connect')} className="flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold bg-primary text-on-primary shadow-sm active:scale-95 transition-all"><MIcon name="login" size={16} />登录同步</button>}
                                    {saveStatus === 'idle' && driveConnection === 'connected' && (
                                        <div className="flex items-center gap-1.5 px-3 py-1 rounded-full border border-green-600/30 bg-green-500/10 text-green-600 dark:text-green-400 text-[10px] font-bold"><div className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>Drive 已连接</div>
                                    )}
                                </div>
                                <button onClick={handleRefresh} className={`w-10 h-10 rounded-full flex items-center justify-center hover:bg-surface-container-high text-on-surface-variant ${isLoading ? 'animate-spin' : ''}`}><MIcon name="refresh" /></button>
                                <button onClick={() => setModalMode('settings')} className="w-10 h-10 rounded-full flex items-center justify-center hover:bg-surface-container-high text-on-surface-variant"><MIcon name="settings" /></button>
                            </div>
                        </div>
                        {availableCategories.length > 1 && (<div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">{availableCategories.map(cat => (<button key={cat} onClick={()=>setActiveCategory(cat)} className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-all ${activeCategory===cat ? 'bg-primary text-on-primary shadow-md' : 'bg-surface-container-high text-on-surface-variant hover:bg-surface-container-high/80'}`}>{cat === 'All' ? '全部' : cat}</button>))}</div>)}
                    </header>

                    <main className="w-full px-6 mt-4 flex-1">
                        {sortedItems.length === 0 ? (
                            <div className="flex flex-col items-center justify-center py-32 opacity-50"><MIcon name="event_busy" size={64} className="text-on-surface-variant mb-4" /><p className="text-sm text-on-surface-variant">暂无倒数日</p></div>
                        ) : (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                {sortedItems.map((item) => {
                                    const { days, date, isPast, isDuration } = calculateDaysInternal(item);
                                    return (
                                        <div key={item.id} onClick={() => openAddEdit(item)} className="bg-surface-container/80 backdrop-blur-md rounded-[28px] p-5 border border-outline/10 shadow-sm hover:shadow-xl transition-all cursor-pointer flex flex-col justify-between min-h-[170px]">
                                            <div className="mb-4">
                                                {item.category && (<div className="flex items-center gap-2 mb-2"><span className="text-[10px] px-2 py-0.5 rounded bg-surface-container-high text-on-surface-variant border border-outline/10">{item.category}</span></div>)}
                                                <h3 className="text-lg font-bold text-on-surface truncate pr-6 leading-tight">{item.title}</h3>
                                                <div className="flex items-center gap-1 text-xs text-on-surface-variant opacity-80 mt-1"><MIcon name={isDuration ? 'date_range' : 'event'} size={14} /><span>{getDisplayDateText(item, date)}</span></div>
                                                {item.remarks && (<p className="text-[10px] text-on-surface-variant opacity-60 mt-2 line-clamp-2 leading-relaxed">{item.remarks}</p>)}
                                            </div>
                                            <div className="mt-auto flex justify-between items-end border-t border-outline/5 pt-3">
                                                <span className={`text-[10px] px-2 py-0.5 rounded font-bold ${isPast ? 'bg-surface-container-high text-on-surface-variant' : 'bg-primary-container text-on-primary-container'}`}>{item.statusText || (isPast ? '已过去' : '还有')}</span>
                                                <div className="flex items-baseline text-primary"><span className="text-4xl font-bold tracking-tighter leading-none">{days}</span><span className="text-[10px] ml-1 font-bold opacity-60">天</span></div>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                    </main>

                    <button onClick={() => openAddEdit()} className="fixed bottom-10 right-8 h-16 px-6 rounded-[24px] bg-primary-container text-on-primary-container shadow-xl flex items-center gap-2 active:scale-90 transition-all font-bold z-30 border border-primary/10 hover:shadow-2xl"><MIcon name="add" size={28} /> 新建</button>

                    {/* Modals */}
                    {modalMode && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={() => setModalMode(null)}></div>
                            {modalMode === 'add' && (
                                <div className="bg-surface-container w-full max-w-[380px] rounded-[32px] p-6 shadow-2xl animate-enter z-50 relative">
                                    {editingItem && (<button onClick={handleShare} className="absolute top-6 right-6 p-2 rounded-full bg-surface-container-high text-on-surface-variant hover:bg-primary-container active:scale-95 transition-all"><MIcon name="ios_share" size={20} /></button>)}
                                    <h2 className="text-2xl font-normal text-on-surface mb-6">{editingItem ? '编辑' : '新建'}</h2>
                                    <form onSubmit={handleSave} className="space-y-4">
                                        <div className="bg-surface-container-high rounded-t-xl px-4 py-2 border-b border-outline/20"><label className="text-xs text-primary font-medium uppercase tracking-wider">名称</label><input className="w-full bg-transparent outline-none py-1 text-on-surface font-medium" value={formData.title} onChange={e=>setFormData({...formData, title: e.target.value})} autoFocus required /></div>
                                        <div className="flex gap-3"><div className="flex-1 bg-surface-container-high rounded-t-xl px-4 py-2 border-b border-outline/20"><label className="text-xs text-primary font-medium uppercase tracking-wider">起始日期</label><input type="date" className="w-full bg-transparent outline-none py-1 h-8 text-on-surface" value={formData.date} onChange={e=>setFormData({...formData, date: e.target.value})} required /></div></div>
                                        <div className="bg-surface-container-high rounded-t-xl px-4 py-2 border-b border-outline/20"><label className="text-xs text-primary font-medium uppercase tracking-wider">备注 (可选)</label><textarea className="w-full bg-transparent outline-none py-1 h-12 text-sm resize-none text-on-surface" value={formData.remarks} onChange={e=>setFormData({...formData, remarks: e.target.value})} /></div>
                                        <div className="flex items-center gap-3"><div onClick={()=>setFormData({...formData, isPinned: !formData.isPinned})} className={`flex-1 flex items-center justify-center gap-2 cursor-pointer p-3 rounded-xl border transition-all ${formData.isPinned ? 'bg-secondary-container border-secondary-container' : 'bg-surface border-outline/20'}`}><MIcon name="keep" size={18} />置顶</div></div>
                                        <div className="flex justify-end gap-3 pt-4 border-t border-outline/10">{editingItem && <button type="button" onClick={handleDelete} className="mr-auto text-error text-sm font-medium">删除</button>}<button type="button" onClick={()=>setModalMode(null)} className="px-4 text-primary font-medium">取消</button><button type="submit" className="bg-primary text-on-primary px-8 py-2.5 rounded-full shadow-md font-bold active:scale-95 transition-all">保存</button></div>
                                    </form>
                                </div>
                            )}
                            {modalMode === 'share_preview' && (<div className="bg-surface-container w-full max-w-[340px] rounded-[32px] p-6 shadow-2xl animate-enter z-50 flex flex-col items-center"><h3 className="text-lg font-medium text-on-surface mb-4">保存分享海报</h3>{shareImgUrl && <img src={shareImgUrl} className="w-full rounded-2xl shadow-md mb-6 border border-outline/10" />}<div className="flex gap-3 w-full"><button onClick={()=>setModalMode('add')} className="flex-1 py-2.5 text-primary font-medium text-sm">返回</button><a href={shareImgUrl} download={`countdown_${Date.now()}.png`} className="flex-1 py-2.5 bg-primary text-on-primary rounded-full text-center text-sm font-bold shadow-md">保存图片</a></div></div>)}
                            {modalMode === 'settings' && (
                                <div className="bg-surface-container w-full max-w-[340px] rounded-[32px] p-6 shadow-2xl animate-enter z-50 overflow-y-auto max-h-[85vh]"><h2 className="text-xl font-medium mb-6">设置</h2>
                                    <div className="mb-6"><p className="text-xs font-bold text-primary mb-3">外观主题 (Material You)</p><div className="flex gap-2 justify-center mb-4">{Object.keys(THEMES).map(c => (<div key={c} onClick={()=>handleThemeChange(c, darkMode)} className={`w-8 h-8 rounded-full border-2 transition-all cursor-pointer ${appTheme===c ? 'border-on-surface scale-125' : 'border-transparent opacity-60'}`} style={{background: THEMES[c].light.primary}}></div>))}</div></div>
                                    <div className="bg-surface-container-high rounded-xl p-4 space-y-3"><p className="text-[10px] text-primary bg-primary/10 p-2 rounded">填写 Google Client ID 开启云端自动备份同步。</p><input className="w-full bg-surface p-3 rounded-lg text-xs outline-none" placeholder="Client ID" value={driveConfig.clientId} onChange={e=>setDriveConfig({...driveConfig, clientId: e.target.value})} /><div className="flex gap-2"><button onClick={()=>handleGoogleDriveAction('upload')} className="flex-1 bg-secondary-container py-2 rounded-lg text-xs font-bold active:scale-95 transition-all">登录备份</button><button onClick={()=>handleGoogleDriveAction('download')} className="flex-1 bg-surface py-2 rounded-lg text-xs font-bold active:scale-95 transition-all">登录恢复</button></div></div>
                                    <div><p className="text-xs font-bold text-primary mt-6 mb-3">本地数据管理</p><div className="bg-surface-container-high rounded-xl p-4 flex gap-2"><button onClick={handleExportLocal} className="flex-1 bg-secondary-container py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1"><MIcon name="download" size={16}/> 导出</button><button onClick={()=>fileInputRef.current.click()} className="flex-1 bg-surface py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-1"><MIcon name="upload" size={16}/> 导入</button><input type="file" ref={fileInputRef} onChange={handleImportLocal} accept=".json" className="hidden" /></div></div>
                                    <div className="mt-8 text-center text-[10px] opacity-40">Version 3.6.3 • Build 39</div><button onClick={()=>setModalMode(null)} className="w-full mt-2 text-primary font-medium">关闭</button>
                                </div>
                            )}
                        </div>
                    )}

                    {/* SQUARE CAPTURE AREA (1:1) */}
                    <div className="fixed top-0 left-[-9999px] z-[-1]" style={{width: '500px', height: '500px', backgroundColor: '#f0f4f9'}}>
                        <div ref={shareRef} className="w-full h-full p-8 flex flex-col items-center justify-center relative overflow-hidden" style={{backgroundColor: '#f0f4f9'}}>
                             <div className="absolute top-[-120px] right-[-120px] w-[350px] h-[350px] bg-[#d3e3fd] rounded-full mix-blend-multiply filter blur-[80px] opacity-60"></div>
                             <div className="absolute bottom-[-120px] left-[-120px] w-[350px] h-[350px] bg-[#c2e7ff] rounded-full mix-blend-multiply filter blur-[80px] opacity-60"></div>
                            <div className="relative z-10 bg-white p-10 rounded-[56px] shadow-sm w-full h-full flex flex-col items-center border border-[#e7e7e7]">
                                <div className="mt-6 mb-8 w-full flex flex-col items-center justify-center h-20">
                                    <h1 className="text-3xl font-bold text-[#1f1f1f] text-center leading-tight break-words w-full px-4">{formData.title || '倒数日'}</h1>
                                </div>
                                <div className="px-6 py-2.5 bg-primary-container text-on-primary-container rounded-full text-sm font-black shadow-sm mb-12">
                                    {formData.statusText || (shareItemInfo.isDuration ? '共计' : (shareItemInfo.isPast ? '已过去' : '还有'))}
                                </div>
                                <div className="flex items-baseline justify-center mb-12">
                                     <span className="text-[110px] font-bold text-primary leading-none tracking-tighter" style={{ textShadow: '0 4px 12px rgba(0,0,0,0.05)' }}>{shareItemInfo.days}</span>
                                     <span className="text-2xl text-[#444746] font-bold ml-4 -translate-y-4">天</span>
                                </div>
                                <div className="mt-auto w-full flex flex-col items-center mb-4">
                                    <div className="h-[1.5px] w-1/3 bg-[#e0e2e0] mb-6"></div>
                                    <div className="text-[#444746] text-sm font-bold tracking-[0.15em] opacity-80 uppercase">{editingItem ? getDisplayDateText(formData, shareItemInfo.date || new Date()) : ''}</div>
                                </div>
                                <div className="text-[9px] text-[#8e918f] font-black uppercase tracking-[0.4em] opacity-30 mt-2">Googley Countdown</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
